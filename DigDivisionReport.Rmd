---
title: "道路挖掘核定權責分工研究報告"
author: "Chiahua.Wang"
date: "2020/5/22"
output: html_document
runtime: shiny
---

<div style="font-family:SourceHanSansTC-Regular,思源黑體 標準,微軟正黑體, Microsoft JhengHei,msjh;font-size:16px">

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r base,echo=F,message=F,warning=F}

library(dplyr)
library(jsonlite)
library(ggplot2)
library(knitr)

options(scipen = 99)

roadlist = read.csv(file("road_lev_length.csv",encoding = "big5"),stringsAsFactors = F)
diglist = read.csv(file("DigRoadFromQGIS.csv",encoding = "UTF-8"),stringsAsFactors = F)

if (file.exists("digcase1year.RData")) {
  load(file = "digcase1year.RData")
} else {
  alldig = fromJSON("http://roaddig.kinmen.gov.tw/KMDigAPI/api/OpenData/GetCaseList?sdate=2015-01-01&edate=2019-12-31")
alldig = alldig$Data

alldig = mutate(alldig,
                AllowStart=as.Date(AllowStart),
                AllowStop=as.Date(AllowStop),
                SchedStart=as.Date(SchedStart),
                SchedStop=as.Date(SchedStop),
                Length=as.numeric(Length),
                Width=as.numeric(Width),
                Area=as.numeric(Area),
                Depth=as.numeric(Depth))
alldig$Length[is.na(alldig$Length)] = round(mean(alldig$Length[!is.na(alldig$Length)]),0)
alldig$Width[is.na(alldig$Width)] = round(mean(alldig$Width[!is.na(alldig$Width)]),0)
alldig$Area[is.na(alldig$Area)] = round(mean(alldig$Area[!is.na(alldig$Area)]),0)
alldig$Depth[is.na(alldig$Depth)] = round(mean(alldig$Depth[!is.na(alldig$Depth)]),0)

alldig = filter(alldig,!grepl("^\\(T",EngUse))

alldig =  filter(alldig,CaseStatus %in% c("一般進行狀態","已報完工待收件","已完工收件","已完工","完工回報退件"))

alldig$applydays = as.numeric(difftime(alldig$SchedStop,alldig$SchedStart,units="days"))
alldig = filter(alldig,!is.na(AllowStart))

alldig$lev = "道路"
for (i in 1:nrow(alldig)) {
  if (alldig$CaseID[i] %in% diglist$CASEID) {
    Temp = diglist$路名[diglist$CASEID==alldig$CaseID[i]]
    
    if (Temp!="") {
    Temp = Temp[Temp!=""]
    Temp = Temp[order(desc(nchar(Temp)))]
    Temp = Temp[1]
    if (Temp=="1-1") {Temp="西海路二段"}
    if (Temp=="2-22") {Temp="文化路"}
      alldig$lev[i] = roadlist$lev[roadlist$roadname==Temp]
    } 
  }
  if (alldig$lev[i]=="道路") {
    for (d in 1:nrow(roadlist)) {
    if (grepl(roadlist$roadname[d],alldig$Road[i])) {
      alldig$lev[i] = roadlist$lev[d]
      break
    } 
  }
  }
}


save(alldig,file="digcase1year.RData")
}

alldig$year = year=format(alldig$SchedStart,format="%Y")

```

## 目的

為改善道路挖掘決行層級的劃分，在最佳負荷與有效管理的條件下提升整體行政效率，爰以104至108年5年份之道路挖掘許可案紀錄，進行量化分析及研究。

近5年道挖基本資料如下：

- 道路挖掘許可案量：平均每年`r round(nrow(alldig)/5,2)` 件
- 申請挖掘長度：
  - 總長：平均每年`r round(sum(alldig$Length)/5,2)` 公尺
  - 25%位數：`r as.numeric(quantile(alldig$Length,0.25))` 公尺
  - 中位數：`r as.numeric(quantile(alldig$Length,0.50))` 公尺
  - 75%位數：`r as.numeric(quantile(alldig$Length,0.75))` 公尺
  - 平均： `r round(mean(alldig$Length),2)` 公尺
  - 標準差： `r round(sd(alldig$Length),2)` 公尺
  - 最小： `r min(alldig$Length)` 公尺
  - 最大： `r max(alldig$Length)` 公尺
- 申請挖掘日數：
  - 25%位數：`r as.numeric(quantile(alldig$applydays,0.25))` 天
  - 中位數：`r as.numeric(quantile(alldig$applydays,0.5))` 天
  - 75%位數：`r as.numeric(quantile(alldig$applydays,0.75))` 天
  - 平均： `r round(mean(alldig$applydays),2)` 天
  - 標準差： `r round(sd(alldig$applydays),2)` 天
  - 最小： `r min(alldig$applydays)` 天
  - 最大： `r max(alldig$applydays)` 天
- 道路分級：
  - 涉及主要道路件數：`r nrow(alldig[alldig$lev=="主要道路",])` 件
  - 涉及次要道路件數：`r nrow(alldig[alldig$lev=="次要道路",])` 件
  - 其他：`r nrow(alldig[alldig$lev=="道路",])` 件

## 劃分方式

決策層級劃分，主要目的是透過**適當的授權**達成減量分工，因此使用什麼條件、如何設定門檻為執行重點。為了讓分工能夠以量化指標快速劃分，在此提出三個衡量指標：

1. 涉及道路種類。例如依主要道路、次要道路等劃分，可連結對道路的重要性。
2. 挖掘長度。可連結對道路破壞的程度。
3. 申請施工日數。可連結對交通影響的程度。

### 門檻值

為找出合理劃分門檻值，我們採用集群分析先對數值進行分群，再檢視各群的數值分析，從而找出適合1層決行者。

```{r kmeans,echo=F,message=F,warning=F}

set.seed(1090524)

k = select(alldig,lev,Length,applydays)
k$lev1 = ifelse(k$lev=="主要道路",1,0)
k$lev2 = ifelse(k$lev=="次要道路",0,1)

k = select(k,-lev)
k = scale(k)

k.m = kmeans(k,5)
alldig$kmeans=k.m$cluster  
k.m.table = k.m$centers %>% 
  cbind(data.frame('件數'=k.m$size)) %>%
  #arrange(desc(Length)) %>% 
  cbind(data.frame('群'=c(1:nrow(k.m$centers))))

k.m.table %>%   
`names<-`(c("申挖長度","申挖日數","涉及主要道路","涉及主次要道路","件數","群別")) %>% 
  kable()
k.m = as.data.frame(k.m$centers)
k1 = as.numeric(rownames(k.m[(k.m$Length>=1),]))
```

按集群分析結果進行分級，建議取分級門檻為涉及「**主要道路**」、「**申挖長度較長**」、「**申挖日數長**」者為第1層決行，並就涉主要道路但挖掘長度較短的部分，再進一步進行集群分析如下：

```{r kmeans2,echo=F,message=F,warning=F}

a = as.numeric(rownames(k.m[k.m$Length<1&k.m$lev1>1,]))
k = select(filter(alldig,kmeans==a),Length,applydays)

k = scale(k)

k.m = kmeans(k,5)
alldig$kmeans2=0
alldig$kmeans2[alldig$kmeans==a]=k.m$cluster  
k.m.table = k.m$centers %>% 
  cbind(data.frame('件數'=k.m$size)) %>%
  #arrange(desc(Length)) %>% 
  cbind(data.frame('群'=c(1:nrow(k.m$centers))))

k.m.table %>%   
`names<-`(c("申挖長度","申挖日數","件數","群別")) %>% 
  kable()
k.m = as.data.frame(k.m$centers)
k2 = as.numeric(rownames(k.m[(k.m$Length>=1)|(k.m$applydays>=1),]))#
```


可以發現部分群別申挖長度相對較長。因此我們選擇**位於主要道路、挖掘長度較長、申挖日數較久**者為第1層決行。

其中申挖日數及長度的量化門檻部分，以決策樹演算法進行分析：

```{r tree1,echo=F,message=F,warning=F}

library(rpart)
library(rpart.plot)

k.tree = alldig
k.tree$one = ifelse((k.tree$kmeans %in% k1)|(k.tree$kmeans2 %in% k2),1,0)
k.tree$lev1 = ifelse(k.tree$lev=="主要道路",1,0)

k.tree = rpart(one~applydays+Length+lev1,data=k.tree)
rpart.plot(k.tree,type=5)

k.predict = alldig
k.predict$one = 0
k.predict$lev1 = ifelse(k.predict$lev=="主要道路",1,0)

k.predict$one = predict(k.tree,newdata = k.predict)
k.predict$year = format(k.predict$SchedStart,format="%Y")
alldig$tree1 = k.predict$one

#table(alldig$tree1)/nrow(alldig)


```

因此我們得到第1層決行條件如下：

1. 主要道路，且申挖日數大於53天。
2. 或非屬主要道路，且申挖日數大於130天。
3. 或非屬主要道路，但申挖日數未達130天且申挖長度大於579公尺。
4. 或申挖日數未達53天，但申挖長度大於502公尺。

## 結論：

因量化分析後的決行條件較為複雜，現行分層決行判斷為人工判斷並非電腦自動識別，因此為利實務執行，建議簡化。原三項變數簡化為二項，並配合調整量化門檻後，建議第1層決行條件如下：

1. 位於**主要道路**，且**申挖日期大於25天**者。
2. 或**非位於主要道路**，但**申挖日期大於200天**者。
3. 專案性道路挖掘許可（禁挖區或重大專案）。

依上述規則分類，預計約有`r round((nrow(alldig[(alldig$lev=="主要道路"&alldig$applydays>=25)|(alldig$lev!="主要道路"&alldig$applydays>=200),]))/nrow(alldig),4)*100`%之案件為第1層決行，餘約`r 100-round((nrow(alldig[(alldig$lev=="主要道路"&alldig$applydays>=25)|(alldig$lev!="主要道路"&alldig$applydays>=200),]))/nrow(alldig),4)*100`%為第2層決行。例如試算近3年度一層及二層決行案件量如下表：

```{r predict,echo=F,message=F,warning=F}

k.predict$one2 = ifelse((k.predict$lev=="主要道路"&k.predict$applydays>=25)|(k.predict$lev!="主要道路"&k.predict$applydays>=200),"一層","二層")

summarise(group_by(k.predict[k.predict$year %in% c("2019","2018","2017"),],year,one2),n=n()) %>% 
  data.frame() %>% 
  `names<-`(c("決行層級","年度","件數")) %>% 
  kable()

```

相較於現行1層決行門檻「主次要道路、50公尺以上」，一層決行案量平均每年約可減少`r round((nrow(k.predict[(k.predict$Length>=50|k.predict$lev=="主要道路"|k.predict$lev=="次要道路")&k.predict$year %in% c("2019","2018","2017"),])-sum(k.predict$one2[k.predict$year %in% c("2019","2018","2017")]=="一層"))/3,2)`件。

## 門檻試算

為利討論及評估，除前述量化指標評估與計算說明之外，同步提供互動式計算介面如下。可自行調整「道路等級」及「申挖日數」兩項變數，於圓環圖中心顯示一層決行的比例，及於下方的表格顯示套用於108年度的一層及二層決行各五件案例。

請至網站試算：https://chiahuaw.shinyapps.io/DigDivision

```{r eruptions, echo=FALSE}

inputPanel(
  selectInput("roadlev", label = "一層決行道路等級:",
              choices = c("主要道路","主次要道路","所有道路"), selected = "主要道路"),
  
  sliderInput("days1", label = "申挖日數條件:",
              min = 1, max = 365, value = 25, step = 1),
  sliderInput("days2", label = "超長申挖日數條件:",
              min = 1, max = 500, value = 200, step = 1)
)



renderPlot({
  Temp = alldig
  Temp$lev1 = ifelse(Temp$lev=="道路",0,ifelse(Temp$lev=="主要道路",1,3))
  Temp$one=0
  
  if (input$roadlev=="主要道路") {
    Temp$lev1 = ifelse(Temp$lev=="主要道路",1,0)
  }
  
  if (input$roadlev=="主次要道路") {
    Temp$lev1 = ifelse(Temp$lev!="道路",1,0)
  }
  
  if (input$roadlev=="所有道路") {
    Temp$lev1 = 1
  }
  
  Temp$one = ifelse(((Temp$lev1==1)&(Temp$applydays>=input$days1))|((Temp$lev1!=1)&(Temp$applydays>=input$days2)),1,0)
  
  Temp = summarise(group_by(Temp,one),n=n(),ratio=(round(n/nrow(Temp),4)*100)) %>% 
    data.frame()
  
  p =ggplot(Temp,aes(x="",y=ratio,fill=as.factor(one)))+geom_bar(stat="identity",width = 1) +
    coord_polar("y",start=0)
  p +annotate("text",x=0,y=0.5,label=paste0(Temp$ratio[Temp$one==1][1],"%"))
})


```

### 一層決行案例
```{r eruptions 2, echo=FALSE}


renderTable({
  Temp2 = alldig
  Temp2$lev1 = ifelse(Temp2$lev=="道路",0,ifelse(Temp2$lev=="主要道路",1,3))
  Temp2$one=0
  
  if (input$roadlev=="主要道路") {
    Temp2$lev1 = ifelse(Temp2$lev=="主要道路",1,0)
  }
  
  if (input$roadlev=="主次要道路") {
    Temp2$lev1 = ifelse(Temp2$lev!="道路",1,0)
  }
  
  if (input$roadlev=="所有道路") {
    Temp2$lev1 = 1
  }
  
  Temp2$one = ifelse(((Temp2$lev1==1)&(Temp2$applydays>=input$days1))|((Temp2$lev1!=1)&(Temp2$applydays>=input$days2)),1,0)
  
  Temp2 =filter(Temp2,one==1,year=="2019") %>% 
    sample_n(5) %>% 
    select(CaseID,PPName,EngUse,Road,Length,applydays)
  Temp2 = mutate(Temp2,link=sprintf("https://roaddig.kinmen.gov.tw/KMDigWeb/CM/Print/ApplyForm?caseid=%s" ,CaseID)) %>% 
    `names<-`(c("案號","單位","用途","申挖位置","申挖長度","申挖日數","連結"))
  Temp2
  
})



```

### 二層決行案例
```{r eruptions 3, echo=FALSE}


renderTable({
  Temp2 = alldig
  Temp2$lev1 = ifelse(Temp2$lev=="道路",0,ifelse(Temp2$lev=="主要道路",1,3))
  Temp2$one=0
  
  if (input$roadlev=="主要道路") {
    Temp2$lev1 = ifelse(Temp2$lev=="主要道路",1,0)
  }
  
  if (input$roadlev=="主次要道路") {
    Temp2$lev1 = ifelse(Temp2$lev!="道路",1,0)
  }
  
  if (input$roadlev=="所有道路") {
    Temp2$lev1 = 1
  }
  
  Temp2$one = ifelse(((Temp2$lev1==1)&(Temp2$applydays>=input$days1))|((Temp2$lev1!=1)&(Temp2$applydays>=input$days2)),1,0)
  
  Temp2 =filter(Temp2,one==0,year=="2019") %>% 
    sample_n(5) %>% 
    select(CaseID,PPName,EngUse,Road,Length,applydays)
  Temp2 = mutate(Temp2,link=sprintf("https://roaddig.kinmen.gov.tw/KMDigWeb/CM/Print/ApplyForm?caseid=%s" ,CaseID)) %>% 
    `names<-`(c("案號","單位","用途","申挖位置","申挖長度","申挖日數","連結"))
  Temp2
  
})
  

```


</div>
